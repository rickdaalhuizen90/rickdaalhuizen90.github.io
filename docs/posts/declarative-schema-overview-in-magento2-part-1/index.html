<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Declarative Schema Overview in Magento 2 - Part 1 - Rick Daalhuizen</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://rickdaalhuizen.comfavicon.png><link rel=stylesheet href=/css/style.min.4b2bfb3701049fe0da3e8d6b9d15186ba1dc7e294f0be3e2bca21bb8a330f5dd.css><meta name=description content="What are declarative schema in Magento 2 and how to use them."><meta property="og:title" content="Declarative Schema Overview in Magento 2 - Part 1"><meta property="og:type" content="website"><meta property="og:url" content="https://rickdaalhuizen.com/posts/declarative-schema-overview-in-magento2-part-1/"><meta property="og:description" content="What are declarative schema in Magento 2 and how to use them."><meta name=twitter:card content="summary"><meta name=twitter:site content="@zerostaticio"><meta name=twitter:creator content="@zerostaticio"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class="page page-default-single"><div id=wrapper class=wrapper><div class=header><a class=header-logo href=https://rickdaalhuizen.com>Rick Daalhuizen</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/>About</a></li><li class=menu-item-posts><a href=/posts/>Posts</a></li></ul></div></div><div class=intro><h1>Declarative Schema Overview in Magento 2 - Part 1<span class=dot>.</span></h1></div><div class=content><p>When we make changes to our database it&rsquo;s usually done through an installation or upgrade script. We start by creating an install script that has a php class &ldquo;InstallSchema&rdquo; and in it we write our PHP code to make adjustments to the database. Then when we need to change a table, we create an &ldquo;UpgradeSchema&rdquo;, look at the version where it needs to upgrade and add our changes.</p><h2 id=the-disadvantages-of-using-installation-scripts>The disadvantages of using installation scripts</h2><p>During installation, Magento goes through all versions of the module until the latest version is reached. That looks like this:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>1.0.0 create database schema <span class=o>(</span>install table X<span class=o>)</span>
1.0.1 update database schema <span class=o>(</span>add column A to table X<span class=o>)</span>
1.0.2 update database schema <span class=o>(</span>add column B to table X<span class=o>)</span>
1.0.3 update database schema <span class=o>(</span>remove column A from table X<span class=o>)</span>
</code></pre></div><p>While this all looks good at first, there are a number of drawbacks.</p><p>With this approach, the complexity of our upgrade script increases.</p><p>For example, it is not possible to delete the column you added earlier without increasing the module to a new version. Developers should fully understand what each installation and upgrade script contained without breaking anything. This results in added complexity and possible errors than necessary.</p><p>Fortunately, Magento came up with a solution in the form of a declarative scheme. The new approach allows developers to declare the ultimate desired state of the database and allows the system to automatically adjust to it without the need for redundant operations. In addition, there is no need to write an Uninstall script as the changes are automatically deleted when a module is removed.</p><h2 id=what-are-declarative-schemas>What are declarative schemas?</h2><p>Declarative schemes have been introduced in Magento 2.3 and are a new way to make changes to the database. Using a declarative scheme is not yet a requirement in Magento 2.3 but it is recommended to use it. In addition to all the advantages that have already been mentioned above, it also has the following advantages:</p><ul><li>dry-run mode for installation.</li><li>performance optimization: the declarative schedule approach saves significant time by moving from the current version to the last point.</li><li>supports rollbacks: developers can revert to a previous version.</li><li>validation before installation.</li></ul><h2 id=how-to-use-declarative-schema>How to use declarative schema</h2><p>A declarative scheme comes in the form of an XML file. You can create this by adding a db_schema.xml file in the etc/folder.</p><p>For example, we want a table with the following information, a file name, the location of the file, and a relationship with a quote_item. We call the table &ldquo;quote_item_file&rdquo; with the following columns, filename, location, quote_item_item_id, created_at. This would look like this if we wrote it down in our etc/db_schema.xml.</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=ln> 1</span><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span class=ln> 2</span><span class=nt>&lt;schema</span> <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
<span class=ln> 3</span>       <span class=na>xsi:noNamespaceSchemaLocation=</span><span class=s>&#34;urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd&#34;</span><span class=nt>&gt;</span>
<span class=ln> 4</span>   <span class=nt>&lt;table</span> <span class=na>name=</span><span class=s>&#34;quote_item_file&#34;</span> <span class=na>resource=</span><span class=s>&#34;default&#34;</span> <span class=na>engine=</span><span class=s>&#34;innodb&#34;</span> <span class=na>comment=</span><span class=s>&#34;Quote Item File Table&#34;</span><span class=nt>&gt;</span>
<span class=ln> 5</span>       <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;10&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;true&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;true&#34;</span>
<span class=hl><span class=ln> 6</span>               <span class=na>comment=</span><span class=s>&#34;Entity ID&#34;</span><span class=nt>/&gt;</span>
</span><span class=ln> 7</span>       <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;filename&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span>
<span class=ln> 8</span>               <span class=na>comment=</span><span class=s>&#34;Filename&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 9</span>       <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;location&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span>
<span class=ln>10</span>               <span class=na>comment=</span><span class=s>&#34;Location of file&#34;</span><span class=nt>/&gt;</span>
<span class=ln>11</span>       <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;quote_item_item_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;10&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;true&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span>
<span class=ln>12</span>               <span class=na>comment=</span><span class=s>&#34;Item Id&#34;</span><span class=nt>/&gt;</span>
<span class=ln>13</span>
<span class=ln>14</span>       <span class=c>&lt;!-- Our created_at column --&gt;</span>
<span class=ln>15</span>       <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;timestamp&#34;</span> <span class=na>name=</span><span class=s>&#34;created_at&#34;</span> <span class=na>on_update=</span><span class=s>&#34;false&#34;</span> <span class=na>nullable=</span><span class=s>&#34;true&#34;</span> <span class=na>default=</span><span class=s>&#34;CURRENT_TIMESTAMP&#34;</span>
<span class=ln>16</span>               <span class=na>comment=</span><span class=s>&#34;Created At&#34;</span><span class=nt>/&gt;</span>
<span class=ln>17</span>
<span class=ln>18</span>       <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;primary&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;PRIMARY&#34;</span><span class=nt>&gt;</span>
<span class=ln>19</span>           <span class=nt>&lt;column</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span><span class=nt>/&gt;</span>
<span class=ln>20</span>       <span class=nt>&lt;/constraint&gt;</span>
<span class=ln>21</span>
<span class=ln>22</span>       <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;foreign&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;QUOTE_ITEM_FILE_QUOTE_ITEM&#34;</span>
<span class=ln>23</span>                    <span class=na>table=</span><span class=s>&#34;quote_item_file&#34;</span>
<span class=ln>24</span>                    <span class=na>column=</span><span class=s>&#34;quote_item_item_id&#34;</span>
<span class=ln>25</span>                    <span class=na>referenceTable=</span><span class=s>&#34;quote_item&#34;</span>
<span class=ln>26</span>                    <span class=na>referenceColumn=</span><span class=s>&#34;entity_id&#34;</span> <span class=na>onDelete=</span><span class=s>&#34;CASCADE&#34;</span><span class=nt>/&gt;</span>
<span class=ln>27</span>   <span class=nt>&lt;/table&gt;</span>
<span class=ln>28</span><span class=nt>&lt;/schema&gt;</span>
</code></pre></div><p>If you can see it is straightforward. We start with a table node with the following attributes, name, resource and engine. This again has the subnodes &ldquo;column&rdquo; that describe the columns of our table. In addition, it has a constraint subnode with the type “primary” for our Primary key and a constraint subnode with the type “foreign” when we want to create a relationship with another table, in our case the &ldquo;quote_item” table.</p><p>Then we run:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>bin/magento setup:db-declaration:generate-whitelist --module-name<span class=o>=</span>Module_Name <span class=o>&amp;&amp;</span> bin/magento s:up
</code></pre></div><p>The db_scheme_whitelist.json serves to preserve the Backward compatibility in Magento.</p><p>When we go to our database you will see that our table has been created. If we want to change anything in our table, it is only a matter of modifying the file and running the commands again.</p><figure><img src=magento-table.png alt="Magento 2 Database table"></figure><p>To give an example of how easy this is, we add our created_at column to our table.</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span class=nt>&lt;schema</span> <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span class=na>xsi:noNamespaceSchemaLocation=</span><span class=s>&#34;urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd&#34;</span><span class=nt>&gt;</span>
  <span class=nt>&lt;table</span> <span class=na>name=</span><span class=s>&#34;quote_item_file&#34;</span> <span class=na>resource=</span><span class=s>&#34;default&#34;</span> <span class=na>engine=</span><span class=s>&#34;innodb&#34;</span> <span class=na>comment=</span><span class=s>&#34;Quote Item File Table&#34;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;11&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;false&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;true&#34;</span>
            <span class=na>comment=</span><span class=s>&#34;Entity ID&#34;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;filename&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span>
            <span class=na>comment=</span><span class=s>&#34;Filename&#34;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;location&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span>
            <span class=na>comment=</span><span class=s>&#34;Location of file&#34;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;quote_item_item_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;10&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;true&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;false&#34;</span>
            <span class=na>comment=</span><span class=s>&#34;Item Id&#34;</span><span class=nt>/&gt;</span>
         
    <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;primary&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;PRIMARY&#34;</span><span class=nt>&gt;</span>
      <span class=nt>&lt;column</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;/constraint&gt;</span>
         
    <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;foreign&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;QUOTE_ITEM_FILE_QUOTE_ITEM_ITEM_ID_QUOTE_ITEM_ITEM_ID&#34;</span>
                <span class=na>table=</span><span class=s>&#34;quote_item_file&#34;</span>
                <span class=na>column=</span><span class=s>&#34;quote_item_item_id&#34;</span>
                <span class=na>referenceTable=</span><span class=s>&#34;quote_item&#34;</span>
                <span class=na>referenceColumn=</span><span class=s>&#34;item_id&#34;</span>
                <span class=na>onDelete=</span><span class=s>&#34;CASCADE&#34;</span><span class=nt>/&gt;</span>
  <span class=nt>&lt;/table&gt;</span>
<span class=nt>&lt;/schema&gt;</span>
</code></pre></div><p>Then we run <em>bin/magento s:up</em> again, and see that the column has been added to the database.</p><figure><img src=magento-table-2.png alt="Magento 2 Database table 2"></figure><p>If we want to remove the table completely just delete it from the xml.</p><h2 id=rename-a-table>Rename a table</h2><p>It is possible to rename a table by creating a new table node and deleting the old one. Then we add the &ldquo;onCreate&rdquo; attribute to the new table node containing a method and the current table name as the argument. &ldquo;migrateDataFromAnotherTable (quote_item_file)&rdquo; see as follows.</p><figure><img src=magento-git-diff.png alt="Magento 2 Git diff"></figure><blockquote><p>When renaming a table, remember to regenerate the db_schema_whitelist.json file so it contains the new name in addition to the old one.</p></blockquote><h2 id=conclusion>Conclusion</h2><p>So far the first part about declarative schemes in Magento 2. In the 2nd part I will discuss how you can convert Install/Upgrade scripts to a declarative scheme, dry-runs and how to perform rollbacks.</p></div><div class=footer><div class=footer-social><span class="social-icon social-icon-twitter"><a href=https://twitter.com/zerostaticio title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span>
<span class="social-icon social-icon-github"><a href=https://github.com/zerostaticthemes title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js></script></body></html>