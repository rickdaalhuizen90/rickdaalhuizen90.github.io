<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>The Nomad Coder | Declarative Schema Overview in Magento 2 - Part 2 |</title><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=description content="How to migrate your Install/Upgrade scripts to declarative schema using safe mode and rollbacks in Magento 2."><meta name=generator content="Hugo 0.83.1"><meta property="og:site_name" content="The Nomad Coder"><meta property="og:url" content="https://thenomadcoder.com/posts/declarative-schema-overview-in-magento2-part-2/"><meta property="og:locale" content="en-us"><meta property="og:locale:alternate" content="en_US"><meta property="og:country-name" content="Indonesia"><meta property="og:email" content><meta property="og:title" content="Declarative Schema Overview in Magento 2 - Part 2"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-06-30"><meta property="og:description" content="How to migrate your Install/Upgrade scripts to declarative schema using safe mode and rollbacks in Magento 2."><meta property="og:url" content="https://thenomadcoder.com/posts/declarative-schema-overview-in-magento2-part-2/"><meta property="og:site_name" content="The Nomad Coder"><meta property="og:image" content="https://thenomadcoder.com/posts/declarative-schema-overview-in-magento2-part-2/banner_huf957eb7cc0803733802fcc4099cfd7cb_292548_1500x1500_fill_box_center_2.png"><meta property="og:image:alt" content="Declarative Schema Overview in Magento 2 - Part 2"><meta property="og:tags" content="Magento 2"><meta property="twitter:description" content="How to migrate your Install/Upgrade scripts to declarative schema using safe mode and rollbacks in Magento 2."><meta property="twitter:title" content="Declarative Schema Overview in Magento 2 - Part 2"><meta property="twitter:image" content="https://thenomadcoder.com/posts/declarative-schema-overview-in-magento2-part-2/banner_huf957eb7cc0803733802fcc4099cfd7cb_292548_1500x1500_fill_box_center_2.png"><meta name=google-site-verification content><meta name=application-name content="The Nomad Coder"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="The Nomad Coder"><link rel=icon sizes=16x16 href=favicon-16x16.png><link rel=icon sizes=32x32 href=favicon-32x32.png><link rel=icon sizes=192x192 href=android-chrome-192x192.png><link rel=icon sizes=512x512 href=android-chrome-512x512.png><link rel=apple-touch-icon href=apple-touch-icon.png><meta name=msapplication-TileColor content="#ff0000"><link rel=manifest href=https://thenomadcoder.com/manifest.json><meta name=theme-color content="#ff0000"><link rel=author href=https://thenomadcoder.com/humans.txt><link rel=copyright href=https://thenomadcoder.com/copyright.html><meta name=monetization content="$ilp.uphold.com/PMDha7R3yZgG"><link rel=stylesheet href=https://thenomadcoder.comcss/highlight.css><link href=https://thenomadcoder.com/index.xml rel=alternate type=application/rss+xml title="The Nomad Coder"><link rel=stylesheet href=https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css><style>pre{overflow-x:auto;padding:1rem;border-radius:3px;border:1px solid}code{font-size:1rem}</style></head><body class="sans-serif bg-near-white lh-copy"><main class="center w-100 mw7 pa3 mt5-l"><section class="flex flex-row-l flex-column-reverse"><article class="bb f5 w-100"><a href=https://thenomadcoder.com>Go Back</a><h1 class=ma0>Declarative Schema Overview in Magento 2 - Part 2</h1><p>In the first part we discussed what declarative schemes are, why you should use declarative schemes instead of install / upgrade scripts, how to create, edit and eventually delete a declarative. If you haven&rsquo;t already read the first part, I suggest you take a moment to read this first.
As an example, I created a simple module containing a InstallSchema.php that looks like this.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=ln> 1</span><span class=o>&lt;?</span><span class=nx>php</span>
<span class=ln> 2</span><span class=sd>/**
</span><span class=ln> 3</span><span class=sd>* Copyright (c) 2016 Magento. All rights reserved.
</span><span class=ln> 4</span><span class=sd>* See COPYING.txt for license details.
</span><span class=ln> 5</span><span class=sd>*/</span>
<span class=ln> 6</span>
<span class=ln> 7</span><span class=k>namespace</span> <span class=nx>Rick\Example\Setup</span><span class=p>;</span>
<span class=ln> 8</span>
<span class=ln> 9</span><span class=k>use</span> <span class=nx>Magento\Framework\DB\Ddl\Table</span><span class=p>;</span>
<span class=ln>10</span><span class=k>use</span> <span class=nx>Magento\Framework\Setup\InstallSchemaInterface</span><span class=p>;</span>
<span class=ln>11</span><span class=k>use</span> <span class=nx>Magento\Framework\Setup\ModuleContextInterface</span><span class=p>;</span>
<span class=ln>12</span><span class=k>use</span> <span class=nx>Magento\Framework\Setup\SchemaSetupInterface</span><span class=p>;</span>
<span class=ln>13</span>
<span class=ln>14</span><span class=sd>/**
</span><span class=ln>15</span><span class=sd>* @codeCoverageIgnore
</span><span class=ln>16</span><span class=sd>*/</span>
<span class=ln>17</span><span class=k>class</span> <span class=nc>InstallSchema</span> <span class=k>implements</span> <span class=nx>InstallSchemaInterface</span>
<span class=ln>18</span><span class=p>{</span>
<span class=ln>19</span>   <span class=sd>/**
</span><span class=ln>20</span><span class=sd>    * {@inheritdoc}
</span><span class=ln>21</span><span class=sd>    * @SuppressWarnings(PHPMD.ExcessiveMethodLength)
</span><span class=ln>22</span><span class=sd>    */</span>
<span class=ln>23</span>   <span class=k>public</span> <span class=k>function</span> <span class=nf>install</span><span class=p>(</span><span class=nx>SchemaSetupInterface</span> <span class=nv>$setup</span><span class=p>,</span> <span class=nx>ModuleContextInterface</span> <span class=nv>$context</span><span class=p>)</span>
<span class=ln>24</span>   <span class=p>{</span>
<span class=ln>25</span>       <span class=sd>/**
</span><span class=ln>26</span><span class=sd>        * Create table &#39;quote_item_file&#39;
</span><span class=ln>27</span><span class=sd>        */</span>
<span class=ln>28</span>       <span class=nv>$table</span> <span class=o>=</span> <span class=nv>$setup</span><span class=o>-&gt;</span><span class=na>getConnection</span><span class=p>()</span>
<span class=ln>29</span>           <span class=o>-&gt;</span><span class=na>newTable</span><span class=p>(</span><span class=nv>$setup</span><span class=o>-&gt;</span><span class=na>getTable</span><span class=p>(</span><span class=s1>&#39;quote_item_file&#39;</span><span class=p>))</span>
<span class=ln>30</span>           <span class=o>-&gt;</span><span class=na>addColumn</span><span class=p>(</span>
<span class=ln>31</span>               <span class=s1>&#39;entity_id&#39;</span><span class=p>,</span>
<span class=ln>32</span>               <span class=nx>Table</span><span class=o>::</span><span class=na>TYPE_INTEGER</span><span class=p>,</span>
<span class=ln>33</span>               <span class=k>null</span><span class=p>,</span>
<span class=ln>34</span>               <span class=p>[</span><span class=s1>&#39;nullable&#39;</span> <span class=o>=&gt;</span> <span class=k>false</span><span class=p>,</span> <span class=s1>&#39;primary&#39;</span> <span class=o>=&gt;</span> <span class=k>true</span><span class=p>,</span> <span class=s1>&#39;identity&#39;</span> <span class=o>=&gt;</span> <span class=k>true</span><span class=p>],</span>
<span class=ln>35</span>               <span class=s1>&#39;Entity ID&#39;</span>
<span class=ln>36</span>           <span class=p>)</span>
<span class=ln>37</span>           <span class=o>-&gt;</span><span class=na>addColumn</span><span class=p>(</span>
<span class=ln>38</span>               <span class=s1>&#39;filename&#39;</span><span class=p>,</span>
<span class=ln>39</span>               <span class=nx>Table</span><span class=o>::</span><span class=na>TYPE_TEXT</span><span class=p>,</span>
<span class=ln>40</span>               <span class=mi>255</span><span class=p>,</span>
<span class=ln>41</span>               <span class=p>[</span><span class=s1>&#39;nullable&#39;</span> <span class=o>=&gt;</span> <span class=k>false</span><span class=p>],</span>
<span class=ln>42</span>               <span class=s1>&#39;Filename&#39;</span>
<span class=ln>43</span>           <span class=p>)</span><span class=o>-&gt;</span><span class=na>addColumn</span><span class=p>(</span>
<span class=ln>44</span>               <span class=s1>&#39;location&#39;</span><span class=p>,</span>
<span class=ln>45</span>               <span class=nx>Table</span><span class=o>::</span><span class=na>TYPE_TEXT</span><span class=p>,</span>
<span class=ln>46</span>               <span class=mi>255</span><span class=p>,</span>
<span class=ln>47</span>               <span class=p>[</span><span class=s1>&#39;nullable&#39;</span> <span class=o>=&gt;</span> <span class=k>false</span><span class=p>],</span>
<span class=ln>48</span>               <span class=s1>&#39;Location of file&#39;</span>
<span class=ln>49</span>           <span class=p>)</span><span class=o>-&gt;</span><span class=na>addColumn</span><span class=p>(</span>
<span class=ln>50</span>               <span class=s1>&#39;quote_item_item_id&#39;</span><span class=p>,</span>
<span class=ln>51</span>               <span class=nx>Table</span><span class=o>::</span><span class=na>TYPE_INTEGER</span><span class=p>,</span>
<span class=ln>52</span>               <span class=k>null</span><span class=p>,</span>
<span class=ln>53</span>               <span class=p>[</span><span class=s1>&#39;padding&#39;</span> <span class=o>=&gt;</span> <span class=mi>10</span><span class=p>,</span> <span class=s1>&#39;nullable&#39;</span> <span class=o>=&gt;</span> <span class=k>false</span><span class=p>,</span> <span class=s1>&#39;unsigned&#39;</span> <span class=o>=&gt;</span> <span class=k>true</span><span class=p>],</span>
<span class=ln>54</span>               <span class=s1>&#39;Item Id&#39;</span>
<span class=ln>55</span>           <span class=p>)</span><span class=o>-&gt;</span><span class=na>addForeignKey</span><span class=p>(</span>
<span class=ln>56</span>               <span class=nv>$setup</span><span class=o>-&gt;</span><span class=na>getFkName</span><span class=p>(</span>
<span class=ln>57</span>                   <span class=nv>$setup</span><span class=o>-&gt;</span><span class=na>getTable</span><span class=p>(</span><span class=s1>&#39;quote_item_file&#39;</span><span class=p>),</span>
<span class=ln>58</span>                   <span class=s1>&#39;quote_item_item_id&#39;</span><span class=p>,</span>
<span class=ln>59</span>                   <span class=s1>&#39;quote_item&#39;</span><span class=p>,</span>
<span class=ln>60</span>                   <span class=s1>&#39;item_id&#39;</span>
<span class=ln>61</span>               <span class=p>),</span>
<span class=ln>62</span>               <span class=s1>&#39;quote_item_item_id&#39;</span><span class=p>,</span>
<span class=ln>63</span>               <span class=nv>$setup</span><span class=o>-&gt;</span><span class=na>getTable</span><span class=p>(</span><span class=s1>&#39;quote_item&#39;</span><span class=p>),</span>
<span class=ln>64</span>               <span class=s1>&#39;item_id&#39;</span><span class=p>,</span>
<span class=ln>65</span>               <span class=nx>Table</span><span class=o>::</span><span class=na>ACTION_CASCADE</span>
<span class=ln>66</span>           <span class=p>)</span><span class=o>-&gt;</span><span class=na>setComment</span><span class=p>(</span><span class=s1>&#39;Quote Item File Table&#39;</span><span class=p>);</span>
<span class=ln>67</span>
<span class=ln>68</span>       <span class=nv>$setup</span><span class=o>-&gt;</span><span class=na>getConnection</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>createTable</span><span class=p>(</span><span class=nv>$table</span><span class=p>);</span>
<span class=ln>69</span>   <span class=p>}</span>
<span class=ln>70</span><span class=p>}</span>
</code></pre></div><h2 id=migrate-installupgrade-scripts-to-a-declarative-scheme>Migrate install/upgrade scripts to a declarative scheme</h2><p>Now it is also possible to convert existing installation / upgrade scripts to a declarative scheme with the &ldquo;Schema Listener Tool&rdquo;. It is useful to know that using the Schema listener tool can only be used in developer mode, as it will make changes to the code. In addition, it does not take into account raw SQL data, and custom DDL operations outside of <em>\Magento\Framework\DB\Adapter\Pdo\Mysql</em>.</p><p>To perform the migration, run the following command:</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>bin/magento s:up --convert-old-scripts<span class=o>=</span><span class=m>1</span>
</code></pre></div><blockquote cite=http://example.com/facts class="mh0 mv3 pa3 bg-washed-blue outline shadow-1"><p>For Magento versions less than 2.4 use the - convert_old_scripts flag</p></blockquote><p>Note that this only works during an installation or upgrade of your modules. If you have issues generating the <em>db_schema.xml</em>, try removing the module entry in the setup_module table and then run setup:upgrade again.</p><p>This will generate a <em>db_schema.xml</em> in your module etc directory.</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=ln> 1</span><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span class=ln> 2</span><span class=nt>&lt;schema</span> <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span class=na>xsi:noNamespaceSchemaLocation=</span><span class=s>&#34;urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd&#34;</span><span class=nt>&gt;</span>
<span class=ln> 3</span> <span class=nt>&lt;table</span> <span class=na>name=</span><span class=s>&#34;quote_item_file&#34;</span> <span class=na>resource=</span><span class=s>&#34;default&#34;</span> <span class=na>engine=</span><span class=s>&#34;innodb&#34;</span> <span class=na>comment=</span><span class=s>&#34;Quote Item File Table&#34;</span><span class=nt>&gt;</span>
<span class=ln> 4</span>   <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;11&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;false&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;true&#34;</span> <span class=na>comment=</span><span class=s>&#34;Entity ID&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 5</span>   <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;filename&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span> <span class=na>comment=</span><span class=s>&#34;Filename&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 6</span>   <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;location&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span> <span class=na>comment=</span><span class=s>&#34;Location of file&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 7</span>   <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;quote_item_item_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;10&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;true&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;false&#34;</span> <span class=na>comment=</span><span class=s>&#34;Item Id&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 8</span>   <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;primary&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;PRIMARY&#34;</span><span class=nt>&gt;</span>
<span class=ln> 9</span>     <span class=nt>&lt;column</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span><span class=nt>/&gt;</span>
<span class=ln>10</span>   <span class=nt>&lt;/constraint&gt;</span>
<span class=ln>11</span>   <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;foreign&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;QUOTE_ITEM_FILE_QUOTE_ITEM_ITEM_ID_QUOTE_ITEM_ITEM_ID&#34;</span> <span class=na>table=</span><span class=s>&#34;quote_item_file&#34;</span> <span class=na>column=</span><span class=s>&#34;quote_item_item_id&#34;</span> <span class=na>referenceTable=</span><span class=s>&#34;quote_item&#34;</span> <span class=na>referenceColumn=</span><span class=s>&#34;item_id&#34;</span> <span class=na>onDelete=</span><span class=s>&#34;CASCADE&#34;</span><span class=nt>/&gt;</span>
<span class=ln>12</span> <span class=nt>&lt;/table&gt;</span>
<span class=ln>13</span><span class=nt>&lt;/schema&gt;</span>
</code></pre></div><p>Then we add some data</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>magento</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>quote_item_file</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>entity_id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>filename</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=k>location</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>quote_item_item_id</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;examole.png&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;media/foo/bar/example.png&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>);</span><span class=w>
</span></code></pre></div><h2 id=what-are-schema-whitelist-and-how-to-create-them>What are schema whitelist and how to create them</h2><p>Scheme whitelist is for backward compatibility. This keeps track of which adjustments have been made to the declarative schemes to prevent data loss, without finding out when this took place. When using an Install/Upgrade script this can often be found in the code.</p><p>The whitelist is generated in <em>&lt;Module_Vendor>/&lt;Module_Name>/etc/db_schema_whitelist.json</em> and can be created as follows:</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>bin/magento setup:db-declaration:generate-whitelist --module-name<span class=o>=</span>&lt;Module_Name&gt;
</code></pre></div><p>And looks like this</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
   <span class=nt>&#34;quote_item_file&#34;</span><span class=p>:</span> <span class=p>{</span>
       <span class=nt>&#34;column&#34;</span><span class=p>:</span> <span class=p>{</span>
           <span class=nt>&#34;entity_id&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
           <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
           <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
           <span class=nt>&#34;quote_item_item_id&#34;</span><span class=p>:</span> <span class=kc>true</span>
       <span class=p>},</span>
       <span class=nt>&#34;constraint&#34;</span><span class=p>:</span> <span class=p>{</span>
           <span class=nt>&#34;PRIMARY&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
           <span class=nt>&#34;QUOTE_ITEM_FILE_QUOTE_ITEM_ITEM_ID_QUOTE_ITEM_ITEM_ID&#34;</span><span class=p>:</span> <span class=kc>true</span>
       <span class=p>}</span>
   <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><blockquote cite=http://example.com/facts class="mh0 mv3 pa3 bg-washed-blue outline shadow-1"><p>As a best practice, you should generate a new whitelist file for each release. You must generate the whitelist for any release that contains changes in the db_schema.xml file.</p></blockquote><h2 id=make-use-of-dry-runs>Make use of dry-runs</h2><p>Now we&rsquo;ve created our <em>db_schema.xml</em> and we want to alter the table in any way like adding a column, we can use dry-runs. Dry-runs assure that you don&rsquo;t have to worry about the script breaking something. No changes are made to the database during a dry run.</p><p>Let&rsquo;s remove one of the columns</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=ln> 1</span><span class=cp>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span class=ln> 2</span><span class=nt>&lt;schema</span> <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span class=na>xsi:noNamespaceSchemaLocation=</span><span class=s>&#34;urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd&#34;</span><span class=nt>&gt;</span>
<span class=ln> 3</span>  <span class=nt>&lt;table</span> <span class=na>name=</span><span class=s>&#34;quote_item_file&#34;</span> <span class=na>resource=</span><span class=s>&#34;default&#34;</span> <span class=na>engine=</span><span class=s>&#34;innodb&#34;</span> <span class=na>comment=</span><span class=s>&#34;Quote Item File Table&#34;</span><span class=nt>&gt;</span>
<span class=ln> 4</span>    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;11&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;false&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;true&#34;</span> <span class=na>comment=</span><span class=s>&#34;Entity ID&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 5</span>    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;varchar&#34;</span> <span class=na>name=</span><span class=s>&#34;filename&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>length=</span><span class=s>&#34;255&#34;</span> <span class=na>comment=</span><span class=s>&#34;Filename&#34;</span><span class=nt>/&gt;</span>
<span class=hl><span class=ln> 6</span>    <span class=c>&lt;!-- &lt;column xsi:type=&#34;varchar&#34; name=&#34;location&#34; nullable=&#34;false&#34; length=&#34;255&#34; comment=&#34;Location of file&#34;/&gt; --&gt;</span>
</span><span class=ln> 7</span>    <span class=nt>&lt;column</span> <span class=na>xsi:type=</span><span class=s>&#34;int&#34;</span> <span class=na>name=</span><span class=s>&#34;quote_item_item_id&#34;</span> <span class=na>padding=</span><span class=s>&#34;10&#34;</span> <span class=na>unsigned=</span><span class=s>&#34;true&#34;</span> <span class=na>nullable=</span><span class=s>&#34;false&#34;</span> <span class=na>identity=</span><span class=s>&#34;false&#34;</span> <span class=na>comment=</span><span class=s>&#34;Item Id&#34;</span><span class=nt>/&gt;</span>
<span class=ln> 8</span>    <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;primary&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;PRIMARY&#34;</span><span class=nt>&gt;</span>
<span class=ln> 9</span>      <span class=nt>&lt;column</span> <span class=na>name=</span><span class=s>&#34;entity_id&#34;</span><span class=nt>/&gt;</span>
<span class=ln>10</span>    <span class=nt>&lt;/constraint&gt;</span>
<span class=ln>11</span>    <span class=nt>&lt;constraint</span> <span class=na>xsi:type=</span><span class=s>&#34;foreign&#34;</span> <span class=na>referenceId=</span><span class=s>&#34;QUOTE_ITEM_FILE_QUOTE_ITEM_ITEM_ID_QUOTE_ITEM_ITEM_ID&#34;</span> <span class=na>table=</span><span class=s>&#34;quote_item_file&#34;</span> <span class=na>column=</span><span class=s>&#34;quote_item_item_id&#34;</span> <span class=na>referenceTable=</span><span class=s>&#34;quote_item&#34;</span> <span class=na>referenceColumn=</span><span class=s>&#34;item_id&#34;</span> <span class=na>onDelete=</span><span class=s>&#34;CASCADE&#34;</span><span class=nt>/&gt;</span>
<span class=ln>12</span>  <span class=nt>&lt;/table&gt;</span>
<span class=ln>13</span><span class=nt>&lt;/schema&gt;</span>
</code></pre></div><p>Run the following commands to use dry-runs:</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>bin/magento s:up --dry-run<span class=o>=</span><span class=m>1</span>
</code></pre></div><p>After you have performed the operation, a log file will be generated in <em>&lt;Magento_Root>/var/log/ dry-run-installation.log</em>. This file contains raw SQL statements and can be used to optimize or modify your script where necessary.</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>www-data@example-php-fpm:06:57 PM:/var/www/html$ cat var/log/dry-run-installation.log
ALTER TABLE <span class=sb>`</span>quote_item_file<span class=sb>`</span> DROP COLUMN <span class=sb>`</span>location<span class=sb>`</span>
</code></pre></div><h2 id=how-to-perform-rollbacks>How to perform rollbacks</h2><p>If for some reason something went wrong during the migration, a rollback can be used. For those who are not yet familiar with rollbacks, it ensures that the recent changes that have been made can be reversed.</p><p>Using the safe mode option will create a CSV file each time a destructive operation for a table or column occurs.</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>bin/magento s:up --safe-mode<span class=o>=</span><span class=m>1</span>
</code></pre></div><p>This will create a csv file under one of these locations:</p><ul><li><em>&lt;Magento_root>/var/declarative_dumps_csv/{column_name_column_type_other_dimensions}.csv</em></li><li><em>&lt;Magento_root>/var/declarative_dumps_csv/{table_name}.csv</em></li></ul><p>The csv file contains information from your database table, rows, columns, and values that have been modified for the installation.
In our example it looks like this</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>www-data@example-php-fpm:07:40 PM:/var/www/html$ cat var/declarative_dumps_csv/quote_item_file_column_location.csv
entity_id,location
1,media/foo/bar/example.png
</code></pre></div><p>After verifying that everything is oke, we can remove the column from the table and run:</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>bin/magento s:up
</code></pre></div><p>To revert everything back to the way it was, we just need to put the column we deleted back into <em>db_schema.xml</em>.</p><p>Finally we run the following to perform the rollback.</p><div class=highlight><pre class=chroma><code class=language-zsh data-lang=zsh>bin/magento s:up --data-restore<span class=o>=</span><span class=m>1</span>
</code></pre></div><blockquote cite=http://example.com/facts class="mh0 mv3 pa3 bg-washed-blue outline shadow-1"><p>-data-restore=1 is only possible with the setup:upgrade command</p></blockquote><h2 id=conclusion>Conclusion</h2><p>I hope I&rsquo;ve informed you enough about what declarative schemes in Magento are and how you can use them. I also recommend that you read the Magento documentation about &ldquo;Migrate install/upgrade scripts to declarative schema&rdquo; if you want to know more about it. For feedback or comments, please leave a message below.</p></article></section><div class="list w-100"><h2 class="f3 mv3">Posts</h2><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">11 Sep</time>
<a class="w-90 link black-90 f4" href=/posts/moving-from-sequel-pro-to-sequel-ace/>Moving from Sequel Pro to Sequel Ace</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">4 Sep</time>
<a class="w-90 link black-90 f4" href=/posts/utilize-configuration-xml-and-variables-scope/>Utilize configuration XML and variables scope.</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">19 Aug</time>
<a class="w-90 link black-90 f4" href=/posts/understanding-magento-2-module-based-architecture/>Understanding Magento 2 Module-Based Architecture</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">4 Aug</time>
<a class="w-90 link black-90 f4" href=/posts/how-to-configure-a-magento-multi-store-in-docker/>How to Configure a Magento Multistore in Docker</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">28 Jul</time>
<a class="w-90 link black-90 f4" href=/posts/how-to-setup-a-multistore-in-magento2/>How to Setup a Multistore in Magento 2</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">21 Jul</time>
<a class="w-90 link black-90 f4" href=/posts/how-to-setup-a-magento-2-development-environment-with-docker/>How to Setup a Magento 2 Development Environment with Docker</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">14 Jul</time>
<a class="w-90 link black-90 f4" href=/posts/jazz-up-your-zsh-terminal-with-prezto/>Jazz Up your ZSH Terminal with Prezto</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">7 Jul</time>
<a class="w-90 link black-90 f4" href=/posts/setting-up-phpstorm-for-magento-2/>Setting up PhpStorm for Magento 2</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">30 Jun</time>
<a class="w-90 link black-90 f4" href=/posts/declarative-schema-overview-in-magento2-part-2/>Declarative Schema Overview in Magento 2 - Part 2</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">23 Jun</time>
<a class="w-90 link black-90 f4" href=/posts/declarative-schema-overview-in-magento2-part-1/>Declarative Schema Overview in Magento 2 - Part 1</a></div><div class="f5 flex mb1 pa1 items-center dim"><time class="w-10 f6 fw4 mt0 mb0 black-60">16 Jun</time>
<a class="w-90 link black-90 f4" href=/posts/magento-2-module-development-with-pestle/>Magento 2 Module Development with Pestle</a></div></div></main><footer class="pv4 ph3 ph5-m ph6-l mid-gray"><small class="f6 db tc">© 2016 <b class=ttu>Rick Daalhuizen</b>, All Rights Reserved</small></footer></body></html>